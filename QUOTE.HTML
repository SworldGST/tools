<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Quotation Maker - S World</title>
<style>
/* === Base Styles === */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  background-color: #f9faff;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  align-items: center;
}
header {
  background: linear-gradient(90deg, #a0d8f1, #cce7f9);
  color: #004e92;
  padding: 18px;
  text-align: center;
  font-weight: bold;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}
header h1 {
  margin: 0;
  font-size: 1.5em;
  letter-spacing: 0.3px;
}
.logo { height: 60px; width: auto; padding: 5px; }
.subheader { width: 100%; text-align: center; margin: 10px 0; }
.subheader h2 { margin: 0; font-size: 1.2em; font-weight: normal; color: #004e92; }
main { display: flex; flex-wrap: wrap; justify-content: center; padding: 20px; gap: 12px; width: 100%; max-width: 1400px; padding-bottom: 120px; }
.column { flex: 1 1 300px; background: #ffffff; padding: 15px; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
label { display: block; margin-top: 10px; font-weight: 600; color: #004e92; font-size: 0.9em; }
input[type="text"], input[type="number"], select, input[type="date"], textarea { width: 100%; padding: 6px 10px; margin-top: 6px; border-radius: 4px; border: 1px solid #99ccee; font-size: 0.95em; background: #f0f8ff; box-sizing: border-box; }
input:focus, select:focus, textarea:focus { border-color: #66b2ff; box-shadow: 0 0 4px rgba(102,178,255,0.3); outline: none; }
textarea { resize: vertical; min-height: 60px; }
.table-responsive { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; min-width: 700px; }
th, td { border: 1px solid #99ccee; padding: 6px 8px; text-align: left; }
th { background: #cce7f9; color: #004e92; }
td input, td select { width: 100%; padding: 4px; box-sizing: border-box; }
td.numeric { text-align:right; }
button { padding: 8px 12px; margin-top: 8px; font-size: 0.95em; border-radius: 5px; cursor: pointer; border: none; }
#addRowBtn { background-color: #99d1ff; color: #004e92; }
#addRowBtn:hover { background-color: #66b2ff; color: white; }
#recalculateBtn { background-color: #ffb84d; color: #004e92; }
#recalculateBtn:hover { background-color: #e69500; color: white; }
#generatePdfBtn { background-color: #4dc080; color: white; }
#generatePdfBtn:hover { background-color: #339966; }
footer { position: fixed; bottom: 0; left: 0; width: 100%; background: linear-gradient(90deg, #0a74da, #005ba0); color: white; text-align: center; padding: 10px; font-size: 0.9em; z-index: 1000; }
@media(max-width: 768px){ .column { flex: 1 1 100%; } .table-responsive { overflow-x: auto; } .summary { flex-direction: column; } .summary div { flex: none; width: 100%; } }
@media (max-width: 600px) { main { flex-direction: column; padding: 10px; } .column { flex: 1 1 100% !important; width: 100% !important; } .column button, #addRowBtn, #recalculateBtn, #generatePdfBtn { flex: 1 1 auto; width: 100%; } .summary { flex-direction: column; } .summary div { width: 100%; } .upload-group { flex-direction: column; align-items: stretch; } .upload-group input[type="file"], .upload-group .clear-button { width: 100%; } label { margin-top: 14px; font-size: 1rem; } input, select, textarea { font-size: 1rem; padding: 8px 10px; } }
.summary { display:flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
.summary div{ flex:1 1 200px; }
.reset-button { background-color: #e74c3c; color: white; padding: 6px 10px; margin-left: 10px; }
.reset-button:hover { background-color: #c0392b; }
.upload-group { display: flex; align-items: center; gap: 10px; }
.upload-group input[type="file"] { flex: 1; }
.upload-group .clear-button { background-color: #e74c3c; color: white; padding: 6px 10px; }
.upload-group .clear-button:hover { background-color: #c0392b; }
.deleteRowBtn { background-color: #e74c3c; color: white; padding: 6px 10px; border-radius: 4px; cursor: pointer; border: none; }
.deleteRowBtn:hover { background-color: #c0392b; }
</style>
</head>
<body>

<header>
  <img src="S World Logo (2).png" alt="S World Logo" class="logo">
  <h1>FREE TAX TOOLS BY S WORLD</h1>
</header>
<div class="subheader">
  <h2>QUOTATION MAKER</h2>
</div>

<main>
  <div class="column">
    <label for="sellerName">Seller Name</label>
    <input type="text" id="sellerName">
    <button class="reset-button" onclick="clearDetails('seller')">Reset Seller</button>

    <label for="sellerGST">Seller GSTIN (optional)</label>
    <input type="text" id="sellerGST">

    <label for="sellerAddress">Address</label>
    <textarea id="sellerAddress"></textarea>

    <label for="sellerState">State</label>
    <select id="sellerState"></select>

    <label for="sellerMobile">Mobile No.</label>
    <input type="text" id="sellerMobile">
  </div>

  <div class="column">
    <label for="buyerName">Buyer Name</label>
    <input type="text" id="buyerName">
    <button class="reset-button" onclick="clearDetails('buyer')">Reset Buyer</button>
    
    <label for="buyerGST">Buyer GSTIN (optional)</label>
    <input type="text" id="buyerGST">
    
    <label for="buyerAddress">Address</label>
    <textarea id="buyerAddress"></textarea>

    <label for="buyerState">State</label>
    <select id="buyerState"></select>

    <label for="buyerMobile">Mobile No.</label>
    <input type="text" id="buyerMobile">
  </div>

  <div class="column">
    <label for="invoiceNo">Quotation No.</label>
    <input type="text" id="invoiceNo">

    <label for="invoiceDate">Date</label>
    <input type="date" id="invoiceDate">

    <label for="paymentTerms">Payment Terms</label>
    <textarea id="paymentTerms" placeholder="e.g. 50% advance, balance on delivery. Valid for 15 days."></textarea>

    <label for="bankName">Bank Name</label>
    <input type="text" id="bankName">

    <label for="accountNo">Account Number</label>
    <input type="text" id="accountNo">

    <label for="ifsc">IFSC Code</label>
    <input type="text" id="ifsc">

    <label for="branch">Branch</label>
    <input type="text" id="branch">
  </div>

  <div class="column" style="flex-basis:100%;">
    <div class="table-responsive">
      <table id="itemsTable">
        <thead>
          <tr>
            <th>Item No</th>
            <th>Item Name</th>
            <th>HSN Code</th>
            <th>Qty</th>
            <th>Price (INR)</th>
            <th>Total (INR)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="text" class="itemNo" value="1"></td>
            <td><input type="text" class="itemName"></td>
            <td><input type="text" class="hsnCode"></td>
            <td><input type="number" class="quantity" value="1" min="1"></td>
            <td><input type="number" class="price" value="0" min="0" step="0.01"></td>
            <td class="total numeric">0</td>
            <td><button class="deleteRowBtn" onclick="deleteRow(this)">X</button></td>
          </tr>
        </tbody>
        <tfoot>
          <tr style="font-weight:bold;">
            <td colspan="5">Grand Total</td>
            <td class="grandTotal numeric">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px;">
      <button id="addRowBtn" onclick="addItem()">Add Row</button>
      <button id="recalculateBtn" onclick="calculateInvoice()">Recalculate</button>
      <button id="generatePdfBtn" onclick="generatePDF()">Generate PDF</button>
    </div>

    <div class="summary">
      <div>
        <label>Total Quotation Value</label>
        <input type="number" id="totalInvoice" readonly>
      </div>
      <div style="flex:1 1 300px;">
        <label>Payment Terms (Summary)</label>
        <textarea id="paymentTermsSummary" readonly></textarea>
      </div>
    </div>
    
    <div style="display:flex; justify-content:space-around; gap:20px; margin-top:20px;">
      <div class="column">
          <label>Upload Company Logo</label>
          <div class="upload-group">
              <input type="file" id="logoUpload" accept="image/*">
              <button class="clear-button" onclick="clearImage('logo')">Clear</button>
          </div>
      </div>
      <div class="column">
          <label>Upload Signature</label>
          <div class="upload-group">
              <input type="file" id="signatureUpload" accept="image/*">
              <button class="clear-button" onclick="clearImage('signature')">Clear</button>
          </div>
      </div>
    </div>
  </div>
</main>

<footer>Software Developed By: S World The Complete Accounting Solutions, Balaghat. Mobile: 8319601616</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// === States ===
const states = ["Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat","Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh","Maharashtra","Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Punjab","Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura","Uttar Pradesh","Uttarakhand","West Bengal","Andaman & Nicobar Islands","Chandigarh","Dadra & Nagar Haveli and Daman & Diu","Delhi","Jammu & Kashmir","Ladakh","Lakshadweep","Puducherry"];
const sellerStateSelect=document.getElementById('sellerState');
const buyerStateSelect=document.getElementById('buyerState');
states.forEach(st=>{ sellerStateSelect.add(new Option(st,st)); buyerStateSelect.add(new Option(st,st)); });
if(document.getElementById('invoiceDate')) document.getElementById('invoiceDate').valueAsDate=new Date();

// === Local Storage Keys ===
const LS_SELLER = 'sellerDetails_v1';
const LS_BUYER = 'buyerDetails_v1';
const LS_ITEMS = 'quotationItems_v1';
const LS_PAYMENT = 'paymentTerms_v1';
const LS_BANK = 'bankDetails_v1';
const LS_LOGO = 'logo_v1';
const LS_SIG = 'signature_v1';

// === Save / Load Helpers ===
function saveDetails(prefix){
  const obj = {};
  const fields = prefix === 'seller' ? ['sellerName','sellerGST','sellerAddress','sellerState','sellerMobile'] : ['buyerName','buyerGST','buyerAddress','buyerState','buyerMobile'];
  fields.forEach(k=>{ const el=document.getElementById(k); if(el) obj[k]=el.value; });
  localStorage.setItem(prefix==='seller'?LS_SELLER:LS_BUYER, JSON.stringify(obj));
}

function loadDetails(prefix){
  const key = prefix==='seller'?LS_SELLER:LS_BUYER;
  const saved = localStorage.getItem(key);
  if(saved){ const obj = JSON.parse(saved); for(const k in obj){ const el=document.getElementById(k); if(el) el.value = obj[k]; } }
}

function clearDetails(prefix){
  if(prefix==='seller') localStorage.removeItem(LS_SELLER); else localStorage.removeItem(LS_BUYER);
  document.querySelectorAll(`#${prefix}Name, #${prefix}GST, #${prefix}Address, #${prefix}State, #${prefix}Mobile`).forEach(input=>{ if(!input) return; if(input.tagName==='SELECT') input.selectedIndex=0; else input.value=''; });
}

// Items
function saveItems(){
  const items = [];
  document.querySelectorAll('#itemsTable tbody tr').forEach(r=>{
    items.push({
      itemNo: r.querySelector('.itemNo') ? r.querySelector('.itemNo').value : '',
      itemName: r.querySelector('.itemName') ? r.querySelector('.itemName').value : '',
      hsnCode: r.querySelector('.hsnCode') ? r.querySelector('.hsnCode').value : '',
      quantity: r.querySelector('.quantity') ? r.querySelector('.quantity').value : '',
      price: r.querySelector('.price') ? r.querySelector('.price').value : ''
    });
  });
  localStorage.setItem(LS_ITEMS, JSON.stringify(items));
  localStorage.setItem(LS_PAYMENT, document.getElementById('paymentTerms').value || '');
  const bankObj = {
    bankName: document.getElementById('bankName').value || '',
    accountNo: document.getElementById('accountNo').value || '',
    ifsc: document.getElementById('ifsc').value || '',
    branch: document.getElementById('branch').value || ''
  };
  localStorage.setItem(LS_BANK, JSON.stringify(bankObj));
}

function loadItems(){
  const saved = localStorage.getItem(LS_ITEMS);
  if(saved){
    const items = JSON.parse(saved);
    const tbody = document.querySelector('#itemsTable tbody');
    tbody.innerHTML = '';
    items.forEach(it=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="itemNo" value="${escapeHtml(it.itemNo||'')}"></td>
        <td><input type="text" class="itemName" value="${escapeHtml(it.itemName||'')}"></td>
        <td><input type="text" class="hsnCode" value="${escapeHtml(it.hsnCode||'')}"></td>
        <td><input type="number" class="quantity" value="${escapeHtml(it.quantity||1)}" min="1"></td>
        <td><input type="number" class="price" value="${escapeHtml(it.price||0)}" min="0" step="0.01"></td>
        <td class="total numeric">0</td>
        <td><button class="deleteRowBtn" onclick="deleteRow(this)">X</button></td>`;
      tbody.appendChild(tr);
    });
    attachEvents();
    calculateInvoice();
  }
  const pay = localStorage.getItem(LS_PAYMENT);
  if(pay) document.getElementById('paymentTerms').value = pay;
  const bankSaved = localStorage.getItem(LS_BANK);
  if(bankSaved){
    try{ const b = JSON.parse(bankSaved); if(b.bankName) document.getElementById('bankName').value = b.bankName; if(b.accountNo) document.getElementById('accountNo').value = b.accountNo; if(b.ifsc) document.getElementById('ifsc').value = b.ifsc; if(b.branch) document.getElementById('branch').value = b.branch; } catch(e){}
  }
}

// Escape helper for values inserted into HTML
function escapeHtml(unsafe){ return (unsafe+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

// Images
function saveImage(e,key){ const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(ev){ try{ localStorage.setItem(key=== 'logo' ? LS_LOGO : LS_SIG, ev.target.result); alert((key.charAt(0).toUpperCase()+key.slice(1)) + ' uploaded and saved.'); } catch(err){ alert('Image too large to save in localStorage.'); } }; reader.readAsDataURL(file); }
function clearImage(key){ localStorage.removeItem(key==='logo'?LS_LOGO:LS_SIG); document.getElementById(key+'Upload').value=''; alert((key.charAt(0).toUpperCase()+key.slice(1)) + ' cleared.'); }
function loadImages(){ /* no preview shown, images are embedded into PDF when present */ }

// Attach listeners to seller/buyer fields
['sellerName','sellerGST','sellerAddress','sellerState','sellerMobile'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', ()=>saveDetails('seller')); el.addEventListener('change', ()=>saveDetails('seller')); } });
['buyerName','buyerGST','buyerAddress','buyerState','buyerMobile'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', ()=>saveDetails('buyer')); el.addEventListener('change', ()=>saveDetails('buyer')); } });
['paymentTerms','bankName','accountNo','ifsc','branch'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', saveItems); el.addEventListener('change', saveItems); } });

// Add Row
function addItem(){ const tbody=document.querySelector('#itemsTable tbody'); const nextNo = tbody.querySelectorAll('tr').length + 1; const tr=document.createElement('tr'); tr.innerHTML = `
  <td><input type="text" class="itemNo" value="${nextNo}"></td>
  <td><input type="text" class="itemName"></td>
  <td><input type="text" class="hsnCode"></td>
  <td><input type="number" class="quantity" value="1" min="1"></td>
  <td><input type="number" class="price" value="0" min="0" step="0.01"></td>
  <td class="total numeric">0</td>
  <td><button class="deleteRowBtn" onclick="deleteRow(this)">X</button></td>`; tbody.appendChild(tr); attachEvents(); saveItems(); calculateInvoice(); }

// Delete Row
function deleteRow(btn){ const row = btn.closest('tr'); if(row) row.remove(); calculateInvoice(); saveItems(); }

// Attach events on table rows
function attachEvents(){ document.querySelectorAll('#itemsTable tbody tr').forEach((r, idx)=>{ r.querySelectorAll('input').forEach(inp=>{ inp.oninput = ()=>{ calculateInvoice(); saveItems(); }; inp.onchange = ()=>{ calculateInvoice(); saveItems(); }; }); // autofill item number if empty
 const itemNoEl = r.querySelector('.itemNo'); if(itemNoEl && (!itemNoEl.value || itemNoEl.value.trim()==='')) itemNoEl.value = (idx+1); }); }

// Calculate totals
function calculateInvoice(){ let gTotal = 0; document.querySelectorAll('#itemsTable tbody tr').forEach((r, idx)=>{ const qty = parseFloat(r.querySelector('.quantity').value) || 0; const price = parseFloat(r.querySelector('.price').value) || 0; const total = qty * price; const totalEl = r.querySelector('.total'); if(totalEl) totalEl.innerText = total.toFixed(2); const itemNoEl = r.querySelector('.itemNo'); if(itemNoEl && (!itemNoEl.value || itemNoEl.value.trim()==='')) itemNoEl.value = (idx+1); gTotal += total; }); document.querySelector('.grandTotal').innerText = gTotal.toFixed(2); const totalInvoiceEl = document.getElementById('totalInvoice'); if(totalInvoiceEl) totalInvoiceEl.value = gTotal.toFixed(2); const paySum = document.getElementById('paymentTermsSummary'); if(paySum) paySum.value = document.getElementById('paymentTerms').value || ''; }

// Number to words (Indian)
function inWords(num){ num = Number(num)||0; const a=['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen']; const b=['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety']; if(num===0) return 'Zero Only'; if((num.toString()).length>9) return 'Overflow'; const n = ('000000000' + num).substr(-9).match(/(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})/); let str=''; if(Number(n[1])!=0) str += (a[Number(n[1])] || (b[Math.floor(n[1]/10)]+' '+a[n[1]%10])) + ' Crore '; if(Number(n[2])!=0) str += (a[Number(n[2])] || (b[Math.floor(n[2]/10)]+' '+a[n[2]%10])) + ' Lakh '; if(Number(n[3])!=0) str += (a[Number(n[3])] || (b[Math.floor(n[3]/10)]+' '+a[n[3]%10])) + ' Thousand '; if(Number(n[4])!=0) str += (a[Number(n[4])] || (b[Math.floor(n[4]/10)]+' '+a[n[4]%10])) + ' Hundred '; if(Number(n[5])!=0) str += ((str!='')?'and ':'') + (a[Number(n[5])] || (b[Math.floor(n[5]/10)]+' '+a[n[5]%10])) + ' '; return (str.trim() + ' Only'); }

// Helper to get faint watermark
async function getFaintLogo(dataURL, opacity=0.07){ return new Promise(resolve=>{ if(!dataURL) return resolve(null); const img = new Image(); img.onload = ()=>{ const canvas = document.createElement('canvas'); canvas.width = img.naturalWidth; canvas.height = img.naturalHeight; const ctx = canvas.getContext('2d'); ctx.globalAlpha = opacity; ctx.drawImage(img,0,0); resolve(canvas.toDataURL('image/png')); }; img.onerror = ()=> resolve(null); img.src = dataURL; }); }

function detectImageFormat(dataURL){ if(!dataURL) return 'PNG'; if(dataURL.indexOf('jpeg')>-1 || dataURL.indexOf('jpg')>-1) return 'JPEG'; if(dataURL.indexOf('png')>-1) return 'PNG'; return 'PNG'; }

// Generate PDF
async function generatePDF(){ try{
  const { jsPDF } = window.jspdf; const doc = new jsPDF('p','mm','a4'); const pageWidth = doc.internal.pageSize.getWidth(); const pageHeight = doc.internal.pageSize.getHeight(); const margin = {left:14, right:14, top:15, bottom:18}; const n = v => (parseFloat(v)||0).toFixed(2);

  const gTotal = parseFloat(document.querySelector('.grandTotal').innerText)||0;
  const totalWords = inWords(Math.round(gTotal));

  // footer
  function addFooter(){ doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(100); doc.text('Software Developed By: S World The Complete Accounting Solutions, Balaghat. Mob: 8319601616', pageWidth/2, pageHeight - 6, {align:'center'}); doc.setTextColor(0); }

  // header draw
  function drawHeader(){
  // Title
  doc.setFont('helvetica','bold');
  doc.setFontSize(15);
  doc.text('QUOTATION', pageWidth/2, margin.top, { align: 'center' });

  let y = 38;

  // Labels (bigger + bold)
  doc.setFont('helvetica','bold');
  doc.setFontSize(12);
  doc.text('Seller:', margin.left, y);
  doc.text('Buyer:', pageWidth/2, y);

  // Details (slightly bigger, normal)
  doc.setFont('helvetica','normal');
  doc.setFontSize(11);

  // Seller details (left column)
  const sName   = document.getElementById('sellerName').value || '-';
  const sGST    = 'GSTIN: ' + (document.getElementById('sellerGST').value || '-');
  const sAddr   = document.getElementById('sellerAddress').value || '-';
  const sState  = 'State: ' + (document.getElementById('sellerState').value || '-');
  const sMobile = 'Mobile: ' + (document.getElementById('sellerMobile').value || '-');

  doc.text(sName, margin.left, y + 7);
  doc.text(sGST, margin.left, y + 13);

  const sLines = doc.splitTextToSize('Address: ' + sAddr, (pageWidth/2 - margin.left - 5));
  doc.text(sLines, margin.left, y + 19);
  let sH = (sLines.length - 1) * doc.getLineHeight() / doc.internal.scaleFactor;
  doc.text(sState, margin.left, y + 19 + sH + 6);
  doc.text(sMobile, margin.left, y + 19 + sH + 12);

  // Buyer details (right column)
  const bName   = document.getElementById('buyerName').value || '-';
  const bGST    = 'GSTIN: ' + (document.getElementById('buyerGST').value || '-');
  const bAddr   = document.getElementById('buyerAddress').value || '-';
  const bState  = 'State: ' + (document.getElementById('buyerState').value || '-');
  const bMobile = 'Mobile: ' + (document.getElementById('buyerMobile').value || '-');

  doc.text(bName, pageWidth/2, y + 7);
  doc.text(bGST, pageWidth/2, y + 13);

  const bLines = doc.splitTextToSize('Address: ' + bAddr, (pageWidth/2 - margin.right - 5));
  doc.text(bLines, pageWidth/2, y + 19);
  let bH = (bLines.length - 1) * doc.getLineHeight() / doc.internal.scaleFactor;
  doc.text(bState, pageWidth/2, y + 19 + bH + 6);
  doc.text(bMobile, pageWidth/2, y + 19 + bH + 12);

  // Add extra blank space below Seller/Buyer details
  const extraGap = 10;

  // Quotation No & Date (bolder)
  const invY = y + 30 + Math.max(sH, bH) + 6 + extraGap;
  const invNo = document.getElementById('invoiceNo').value || '-';

  let formattedDate = '-';
  const invoiceDate = document.getElementById('invoiceDate').value;
  if(invoiceDate){
    const d = invoiceDate.split('-');
    if(d.length === 3) formattedDate = `${d[2]}/${d[1]}/${d[0]}`;
  }

  doc.setFontSize(12);
  doc.setFont('helvetica','bold'); // make Quotation section bold
  doc.text('Quotation No: ' + invNo, margin.left, invY);
  doc.text('Date: ' + formattedDate, pageWidth/2, invY);

  return invY + 10;
}


  // watermark
  const faintLogo = await getFaintLogo(localStorage.getItem(LS_LOGO), 0.06);
  if(faintLogo){ const wmW = pageWidth * 0.35; const wmH = pageHeight * 0.35; const x = (pageWidth - wmW) / 2; const y = (pageHeight - wmH) / 2; doc.addImage(faintLogo, 'PNG', x, y, wmW, wmH); }

  addFooter();
  const headerBottomY = drawHeader();

    // Items table (full width: left margin to right margin, aligned with Payment & Bank section)
  const rows = Array.from(document.querySelectorAll('#itemsTable tbody tr'));
  const head = ['Item No','Item Name','HSN','Qty','Price','Total'];
  const body = rows.map(r=>[
    r.querySelector('.itemNo') ? r.querySelector('.itemNo').value||'-' : '-',
    r.querySelector('.itemName') ? r.querySelector('.itemName').value||'-' : '-',
    r.querySelector('.hsnCode') ? r.querySelector('.hsnCode').value||'-' : '-',
    r.querySelector('.quantity') ? r.querySelector('.quantity').value||'0' : '0',
    r.querySelector('.price') ? (r.querySelector('.price').value||'0') : '0',
    r.querySelector('.total') ? (r.querySelector('.total').innerText||'0') : '0'
  ]);

  // column widths adjusted to span the full printable width
  const availableWidth = pageWidth - margin.left - margin.right;
  const colWidths = {
    0: availableWidth * 0.08,  // Item No
    1: availableWidth * 0.38,  // Item Name
    2: availableWidth * 0.12,  // HSN
    3: availableWidth * 0.10,  // Qty
    4: availableWidth * 0.14,  // Price
    5: availableWidth * 0.18   // Total
  };

  doc.autoTable({
  startY: headerBottomY,
  margin: { left: margin.left, right: margin.right },
  head: [head],
  body: body,
  theme: 'plain',
  styles: { fontSize: 9, lineWidth: 0.2, lineColor: [120,120,120] },
  headStyles: { fillColor: [220,235,245], textColor: [0,0,0], fontStyle: 'bold' },
  columnStyles: Object.assign(
    {},
    ...Object.keys(colWidths).map(k => ({
      [k]: { cellWidth: colWidths[k], halign: ([3,4,5].includes(Number(k)) ? 'right' : 'left') }
    }))
  ),
  didParseCell: function(data){
    const isHead = data.section === 'head' || (data.cell && data.cell.section === 'head');
    if(!isHead) return;

    // Align headers same as their body columns
    if ([3,4,5].includes(data.column.index)) {
      data.cell.styles.halign = 'right';   // Qty, Price, Total headers
    } else {
      data.cell.styles.halign = 'left';    // Item No, Item Name, HSN headers
    }
  }
});


  let cursorY = doc.lastAutoTable.finalY + 8;


  // Terms & Conditions left
  doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.text('Terms & Conditions:', margin.left, cursorY);
  const terms = [
    'This quotation is valid for 15 days from the date of issue.',
'Prices are inclusive of all the applicable taxes',
'Transportation charges, if applicable,  will be charged additionally.',
    'Prices quoted are indicative and subject to confirmation at the time of ordering.',
    'Delivery timelines are approximate and start after order confirmation.'
  ];
  let noteY = cursorY + 6;
  terms.forEach(line=>{
    const wrapped = doc.splitTextToSize(line, (pageWidth/2 - margin.left - 6)); doc.text(wrapped, margin.left, noteY); noteY += wrapped.length * 5 + 2; });

  // Payment summary (right column)
  // --- Payment summary (replace the existing payment autoTable) ---
doc.autoTable({
  startY: cursorY,
  margin:{left: pageWidth/2, right: margin.right},
  head:[['Particulars','Details']],
  body:[
    [ 'Grand Total', n(gTotal) ],
    [ 'Payment Terms', document.getElementById('paymentTerms').value || '-' ]
  ],
  theme:'plain',
  styles:{fontSize:9, lineWidth:0.2, lineColor:[150,150,150]},
  headStyles:{fillColor:[39,174,96], textColor:[255,255,255], fontStyle:'bold'}, // keep visual style
  columnStyles:{
    0:{halign:'left'},   // body col 0 left
    1:{halign:'right'}   // body col 1 right
  },
  didParseCell: function(data){
    // robust check for header cell (works across versions)
    const isHead = data.section === 'head' || (data.cell && data.cell.section === 'head');
    if(!isHead) return;
    if(data.column && data.column.index === 0){
      data.cell.styles.halign = 'left';   // header col 0 -> left
    }
    if(data.column && data.column.index === 1){
      data.cell.styles.halign = 'right';  // header col 1 -> right
    }
  }
});


  let afterPaymentY = doc.lastAutoTable.finalY + 6;

  // Bank details below payment terms (only if any field present)
  const bankName = document.getElementById('bankName').value || ''; const accountNo = document.getElementById('accountNo').value || ''; const ifsc = document.getElementById('ifsc').value || ''; const branch = document.getElementById('branch').value || '';
  const anyBank = bankName.trim() || accountNo.trim() || ifsc.trim() || branch.trim();
  if(anyBank){
    doc.autoTable({
  startY: afterPaymentY,
  margin:{left: pageWidth/2, right: margin.right},
  head:[['Bank Detail','Value']],
  body:[
    [ 'Bank Name', bankName || '-' ],
    [ 'Account No', accountNo || '-' ],
    [ 'IFSC', ifsc || '-' ],
    [ 'Branch', branch || '-' ]
  ],
  theme:'plain',
  styles:{fontSize:9, lineWidth:0.2, lineColor:[150,150,150]},
  headStyles:{fillColor:[52,152,219], textColor:[255,255,255], fontStyle:'bold'},
  columnStyles:{
    0:{halign:'left'},   // body col 0 left
    1:{halign:'right'}   // body col 1 right
  },
  didParseCell: function(data){
    const isHead = data.section === 'head' || (data.cell && data.cell.section === 'head');
    if(!isHead) return;
    if(data.column && data.column.index === 0){
      data.cell.styles.halign = 'left';
    }
    if(data.column && data.column.index === 1){
      data.cell.styles.halign = 'right';
    }
  }
});
  }

  // Add grand total in words under terms (left side)
  const wordsY = Math.max(noteY, afterPaymentY + 6) + 6;
  doc.setFontSize(10); doc.text('Grand Total (in words):', margin.left, wordsY); const wrappedWords = doc.splitTextToSize(totalWords, (pageWidth/2 - margin.left - 6)); doc.text(wrappedWords, margin.left, wordsY + 6);

  // Signature area
  let sigY = Math.max(doc.lastAutoTable ? doc.lastAutoTable.finalY : wordsY + 20, wordsY + wrappedWords.length * 5 + 20) + 12;
  if(sigY > pageHeight - 50){ doc.addPage(); if(localStorage.getItem(LS_LOGO)){ const faint = await getFaintLogo(localStorage.getItem(LS_LOGO), 0.06); if(faint) doc.addImage(faint, 'PNG', (pageWidth - pageWidth*0.35)/2, 60, pageWidth*0.35, pageHeight*0.35); } sigY = 80; drawHeader(); }

  const sigData = localStorage.getItem(LS_SIG);
  if(sigData){ const fmt = detectImageFormat(sigData); try{ doc.addImage(sigData, fmt, pageWidth - margin.right - 40, sigY, 40, 20); } catch(e) { /* ignore image errors */ } sigY += 22; }
  doc.text('For ' + (document.getElementById('sellerName').value || 'Seller'), pageWidth - margin.right, sigY, { align: 'right' }); doc.text('(Authorized Signatory)', pageWidth - margin.right, sigY + 6, { align: 'right' });

  addFooter();
  const buyerNameForFile = (document.getElementById('buyerName').value || 'Buyer').replace(/\s+/g,'_'); const invoiceNoForFile = (document.getElementById('invoiceNo').value || 'Quotation'); doc.save(`${buyerNameForFile}_${invoiceNoForFile}.pdf`);

} catch(err){ console.error(err); alert('Error generating PDF. Check console for details.'); } }

// Load on start
window.addEventListener('load', ()=>{ loadDetails('seller'); loadDetails('buyer'); loadItems(); loadImages(); attachEvents(); calculateInvoice(); });

// Attach image upload handlers
const logoUpload = document.getElementById('logoUpload'); if(logoUpload) logoUpload.addEventListener('change', (e)=>saveImage(e,'logo')); const sigUpload = document.getElementById('signatureUpload'); if(sigUpload) sigUpload.addEventListener('change', (e)=>saveImage(e,'signature'));

</script>
</body>
</html>