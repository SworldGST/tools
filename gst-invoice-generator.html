<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GST Invoice Generator</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  background-color: #f9faff;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  align-items: center;
}

header {
  background: linear-gradient(90deg, #a0d8f1, #cce7f9);
  color: #004e92;
  padding: 18px;
  text-align: center;
  font-weight: bold;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

header h1 {
  margin: 0;
  font-size: 1.5em;
  letter-spacing: 0.3px;
}

.logo {
  height: 60px;
  width: auto;
  padding: 5px;
}

.subheader {
  width: 100%;
  text-align: center;
  margin: 10px 0;
}

.subheader h2 {
  margin: 0;
  font-size: 1.2em;
  font-weight: normal;
  color: #004e92;
}

main {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  padding: 20px;
  gap: 12px;
  width: 100%;
  max-width: 1400px;
  padding-bottom: 120px; /* Increased padding to prevent overlap with fixed footer */
}
.column {
  flex: 1 1 300px;
  background: #ffffff;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
label {
  display: block;
  margin-top: 10px;
  font-weight: 600;
  color: #004e92;
  font-size: 0.9em;
}
input[type="text"], input[type="number"], select, input[type="date"], textarea {
  width: 100%;
  padding: 5px 10px;
  margin-top: 3px;
  border-radius: 4px;
  border: 1px solid #99ccee;
  font-size: 0.9em;
  background: #f0f8ff;
  box-sizing: border-box;
}
input:focus, select:focus, textarea:focus {
  border-color: #66b2ff;
  box-shadow: 0 0 4px rgba(102,178,255,0.3);
  outline: none;
}
textarea {
  resize: vertical;
  min-height: 60px;
}
.table-responsive {
  overflow-x: auto;
  width: 100%; /* Ensure the container respects the parent's width */
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 0.88em;
  /* min-width: 750px; THIS IS THE OLD RULE THAT CAUSED THE ISSUE. IT IS REMOVED. */
}
th, td {
  border: 1px solid #99ccee;
  padding: 4px 6px;
  text-align: left;
}
th {
  background: #cce7f9;
  color: #004e92;
}
td input, td select { width: 100%; padding: 3px; box-sizing: border-box; }
td.numeric { text-align:right; }
button {
  padding: 6px 10px;
  margin-top: 8px;
  font-size: 0.85em;
  border-radius: 5px;
  cursor: pointer;
  border: none;
}
#addRowBtn { background-color: #99d1ff; color: #004e92; }
#addRowBtn:hover { background-color: #66b2ff; color: white; }
#recalculateBtn { background-color: #ffb84d; color: #004e92; }
#recalculateBtn:hover { background-color: #e69500; color: white; }
#generatePdfBtn { background-color: #4dc080; color: white; }
#generatePdfBtn:hover { background-color: #339966; }
footer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: linear-gradient(90deg, #0a74da, #005ba0);
  color: white;
  text-align: center;
  padding: 10px;
  font-size: 0.9em;
  z-index: 1000;
}
@media(max-width: 768px){
  .column { flex: 1 1 100%; }
  .table-responsive { overflow-x: auto; }
  .summary { flex-direction: column; }
  .summary div { flex: none; width: 100%; }
}
.summary {
  display:flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}
.summary div{
  flex:1 1 200px;
}
.reset-button {
  background-color: #e74c3c;
  color: white;
  padding: 5px 8px;
  margin-left: 10px;
}
.reset-button:hover {
  background-color: #c0392b;
}
.upload-group {
    display: flex;
    align-items: center;
    gap: 10px;
}
.upload-group input[type="file"] {
    flex: 1;
}
.upload-group .clear-button {
    background-color: #e74c3c;
    color: white;
    padding: 5px 8px;
}
.upload-group .clear-button:hover {
    background-color: #c0392b;
}

/* Added delete button styling */
.deleteRowBtn {
  background-color: #e74c3c;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  border: none;
}
.deleteRowBtn:hover {
  background-color: #c0392b;
}
</style>
</head>
<body>

<header>
  <img src="S World Logo (2).png" alt="S World Logo" class="logo">
  <h1>FREE TAX TOOLS BY S WORLD</h1>
</header>
<div class="subheader">
  <h2>GST Invoice Generator</h2>
</div>

<main>
  <div class="column">
    <label for="sellerName">Seller Name</label>
    <input type="text" id="sellerName">
    <button class="reset-button" onclick="clearDetails('seller')">Reset Seller</button>

    <label for="sellerGST">Seller GSTIN</label>
    <input type="text" id="sellerGST">

    <label for="sellerAddress">Address</label>
    <textarea id="sellerAddress"></textarea>

    <label for="sellerState">State</label>
    <select id="sellerState"></select>

    <label for="sellerMobile">Mobile No.</label>
    <input type="text" id="sellerMobile">
  </div>

  <div class="column">
    <label for="buyerName">Buyer Name</label>
    <input type="text" id="buyerName">
    <button class="reset-button" onclick="clearDetails('buyer')">Reset Buyer</button>
    
    <label for="buyerGST">Buyer GSTIN</label>
    <input type="text" id="buyerGST">
    
    <label for="buyerAddress">Address</label>
    <textarea id="buyerAddress"></textarea>

    <label for="buyerState">State</label>
    <select id="buyerState"></select>

    <label for="buyerMobile">Mobile No.</label>
    <input type="text" id="buyerMobile">
  </div>

  <div class="column">
    <label for="invoiceNo">Invoice No.</label>
    <input type="text" id="invoiceNo">

    <label for="invoiceDate">Invoice Date</label>
    <input type="date" id="invoiceDate">

    <label for="paymentType">Payment Type</label>
    <select id="paymentType">
      <option value="Cash">Cash</option>
      <option value="UPI">UPI</option>
      <option value="Card">Card</option>
      <option value="Netbanking">Netbanking</option>
    </select>
  </div>

  <div class="column" style="flex-basis:100%;">
    <div class="table-responsive">
      <table id="itemsTable">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>HSN Code</th>
            <th>GST Rate</th>
            <th>Qty</th>
            <th>Price (Incl GST)</th>
            <th>Basic</th>
            <th>SGST</th>
            <th>CGST</th>
            <th>IGST</th>
            <th>Total</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="text" class="itemName"></td>
            <td><input type="text" class="hsnCode"></td>
            <td>
              <select class="gstRate">
                <option value="0">Nil</option>
                <option value="5">5%</option>
                <option value="12">12%</option>
                <option value="18">18%</option>
                <option value="28">28%</option>
              </select>
            </td>
            <td><input type="number" class="quantity" value="1" min="1"></td>
            <td><input type="number" class="price" value="0" min="0"></td>
            <td class="basic numeric">0</td>
            <td class="sgst numeric">0</td>
            <td class="cgst numeric">0</td>
            <td class="igst numeric">0</td>
            <td class="total numeric">0</td>
            <td><button class="deleteRowBtn" onclick="deleteRow(this)">X</button></td>
          </tr>
        </tbody>
        <tfoot>
          <tr style="font-weight:bold;">
            <td colspan="5">Grand Total</td>
            <td class="grandBasic numeric">0</td>
            <td class="grandSGST numeric">0</td>
            <td class="grandCGST numeric">0</td>
            <td class="grandIGST numeric">0</td>
            <td class="grandTotal numeric">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px;">
      <button id="addRowBtn" onclick="addItem()">Add Row</button>
      <button id="recalculateBtn" onclick="calculateInvoice()">Recalculate</button>
      <button id="generatePdfBtn" onclick="generatePDF()">Generate PDF</button>
    </div>

    <div class="summary">
      <div>
        <label>Total Invoice Value</label>
        <input type="number" id="totalInvoice" readonly>
      </div>
      <div>
        <label>Payment Received</label>
        <input type="number" id="paymentReceived" placeholder="Amount" oninput="updateBalance()">
      </div>
      <div>
        <label>Balance Amount</label>
        <input type="number" id="balanceAmount" readonly>
      </div>
      <div>
        <label>Payment Type</label>
        <select id="paymentTypeSummary">
          <option value="Cash">Cash</option>
          <option value="UPI">UPI</option>
          <option value="Card">Card</option>
          <option value="Netbanking">Netbanking</option>
        </select>
      </div>
    </div>
    
    <div style="display:flex; justify-content:space-around; gap:20px; margin-top:20px;">
      <div class="column">
          <label>Upload Company Logo</label>
          <div class="upload-group">
              <input type="file" id="logoUpload" accept="image/*">
              <button class="clear-button" onclick="clearImage('logo')">Clear</button>
          </div>
      </div>
      <div class="column">
          <label>Upload Signature</label>
          <div class="upload-group">
              <input type="file" id="signatureUpload" accept="image/*">
              <button class="clear-button" onclick="clearImage('signature')">Clear</button>
          </div>
      </div>
    </div>
  </div>
</main>

<footer>Software Developed By: S World The Complete Accounting Solutions, Balaghat. Mobile: 8319601616</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// === States ===
const states = ["Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat","Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh","Maharashtra","Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Punjab","Rajasthan","Sikkim","Tamil Nadu","Telangana","Tripura","Uttar Pradesh","Uttarakhand","West Bengal","Andaman & Nicobar Islands","Chandigarh","Dadra & Nagar Haveli and Daman & Diu","Delhi","Jammu & Kashmir","Ladakh","Lakshadweep","Puducherry"];
const sellerStateSelect=document.getElementById('sellerState');
const buyerStateSelect=document.getElementById('buyerState');
states.forEach(st=>{
  let o1=new Option(st,st); sellerStateSelect.add(o1);
  let o2=new Option(st,st); buyerStateSelect.add(o2);
});
document.getElementById('invoiceDate').valueAsDate=new Date();

// === Local Storage Logic (General) ===
function saveDetails(prefix) {
  const details = {};
  document.querySelectorAll(`#${prefix}Name, #${prefix}GST, #${prefix}Address, #${prefix}State, #${prefix}Mobile`).forEach(input => {
    details[input.id] = input.value;
  });
  localStorage.setItem(`${prefix}Details`, JSON.stringify(details));
}

function loadDetails(prefix) {
  const saved = localStorage.getItem(`${prefix}Details`);
  if (saved) {
    const details = JSON.parse(saved);
    for (const key in details) {
      const input = document.getElementById(key);
      if (input) {
        input.value = details[key];
      }
    }
  }
}

function clearDetails(prefix) {
  localStorage.removeItem(`${prefix}Details`);
  document.querySelectorAll(`#${prefix}Name, #${prefix}GST, #${prefix}Address, #${prefix}State, #${prefix}Mobile`).forEach(input => {
    if (input.tagName === 'SELECT') {
      input.selectedIndex = 0;
    } else {
      input.value = '';
    }
  });
}

// === Local Storage Logic (Items) ===
function saveItems() {
  const items = [];
  document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
    const item = {
      itemName: row.querySelector('.itemName').value,
      hsnCode: row.querySelector('.hsnCode').value,
      gstRate: row.querySelector('.gstRate').value,
      quantity: row.querySelector('.quantity').value,
      price: row.querySelector('.price').value
    };
    items.push(item);
  });
  localStorage.setItem('invoiceItems', JSON.stringify(items));
}

function loadItems() {
  const savedItems = localStorage.getItem('invoiceItems');
  if (savedItems) {
    const items = JSON.parse(savedItems);
    const tableBody = document.querySelector('#itemsTable tbody');
    tableBody.innerHTML = ''; // Clear existing rows
    items.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" class="itemName" value="${item.itemName}"></td>
        <td><input type="text" class="hsnCode" value="${item.hsnCode}"></td>
        <td>
          <select class="gstRate">
            <option value="0" ${item.gstRate === "0" ? 'selected' : ''}>Nil</option>
            <option value="5" ${item.gstRate === "5" ? 'selected' : ''}>5%</option>
            <option value="12" ${item.gstRate === "12" ? 'selected' : ''}>12%</option>
            <option value="18" ${item.gstRate === "18" ? 'selected' : ''}>18%</option>
            <option value="28" ${item.gstRate === "28" ? 'selected' : ''}>28%</option>
          </select>
        </td>
        <td><input type="number" class="quantity" value="${item.quantity}" min="1"></td>
        <td><input type="number" class="price" value="${item.price}" min="0"></td>
        <td class="basic numeric">0</td>
        <td class="sgst numeric">0</td>
        <td class="cgst numeric">0</td>
        <td class="igst numeric">0</td>
        <td class="total numeric">0</td>
        <td><button class="deleteRowBtn" onclick="deleteRow(this)">X</button></td>`;
      tableBody.appendChild(row);
    });
    attachEvents();
    calculateInvoice(); // Recalculate totals after loading
  }
}


// Attach event listeners for saving details
document.querySelectorAll('#sellerName, #sellerGST, #sellerAddress, #sellerState, #sellerMobile').forEach(input => {
  input.addEventListener('input', () => saveDetails('seller'));
  input.addEventListener('change', () => saveDetails('seller'));
});
document.querySelectorAll('#buyerName, #buyerGST, #buyerAddress, #buyerState, #buyerMobile').forEach(input => {
  input.addEventListener('input', () => saveDetails('buyer'));
  input.addEventListener('change', () => saveDetails('buyer'));
});
document.getElementById('invoiceNo').addEventListener('input', saveItems);
document.getElementById('invoiceDate').addEventListener('change', saveItems);

// Load details on page load
window.addEventListener('load', () => {
  loadDetails('seller');
  loadDetails('buyer');
  loadItems();
  loadImages();
});

// === Image Uploads ===
document.getElementById('logoUpload').addEventListener('change', (e) => saveImage(e, 'logo'));
document.getElementById('signatureUpload').addEventListener('change', (e) => saveImage(e, 'signature'));

function saveImage(e, key) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      localStorage.setItem(key, event.target.result);
      alert(`${key.charAt(0).toUpperCase() + key.slice(1)} uploaded and saved!`);
    };
    reader.readAsDataURL(file);
  }
}

function clearImage(key) {
  localStorage.removeItem(key);
  document.getElementById(`${key}Upload`).value = '';
  alert(`${key.charAt(0).toUpperCase() + key.slice(1)} cleared!`);
}

function loadImages() {
  // Optional: You could display a preview of the saved images here if needed
}

// === Add Row ===
function addItem(){
  const table=document.querySelector('#itemsTable tbody');
  const row=document.createElement('tr');
  row.innerHTML=`
    <td><input type="text" class="itemName"></td>
    <td><input type="text" class="hsnCode"></td>
    <td>
      <select class="gstRate">
        <option value="0">Nil</option>
        <option value="5">5%</option>
        <option value="12">12%</option>
        <option value="18">18%</option>
        <option value="28">28%</option>
      </select>
    </td>
    <td><input type="number" class="quantity" value="1" min="1"></td>
    <td><input type="number" class="price" value="0" min="0"></td>
    <td class="basic numeric">0</td>
    <td class="sgst numeric">0</td>
    <td class="cgst numeric">0</td>
    <td class="igst numeric">0</td>
    <td class="total numeric">0</td>
    <td><button class="deleteRowBtn" onclick="deleteRow(this)">X</button></td>`;
  table.appendChild(row);
  attachEvents();
  saveItems(); // Save items after adding a new row
}

// === Delete Row ===
function deleteRow(btn){
  const row = btn.closest('tr');
  if (row) row.remove();
  calculateInvoice();
  saveItems();
}

// === Events ===
function attachEvents(){
  document.querySelectorAll('#itemsTable tbody tr').forEach(r=>{
    r.querySelectorAll('input,select').forEach(e=>{
      e.oninput=()=>{ calculateInvoice(); saveItems(); };
      e.onchange=()=>{ calculateInvoice(); saveItems(); };
    });
  });
}

// === Calculate ===
function calculateInvoice(){
  const sellerState=document.getElementById('sellerState').value;
  const buyerState=document.getElementById('buyerState').value;
  let gBasic=0,gSGST=0,gCGST=0,gIGST=0,gTotal=0;
  document.querySelectorAll('#itemsTable tbody tr').forEach(r=>{
    const qty=parseFloat(r.querySelector('.quantity').value)||0;
    const price=parseFloat(r.querySelector('.price').value)||0;
    const gst=parseFloat(r.querySelector('.gstRate').value)||0;
    let basic=(price/(1+gst/100))*qty;
    let sgst=0,cgst=0,igst=0;
    if(sellerState && buyerState){
      if(sellerState===buyerState){ sgst=(basic*gst/100)/2; cgst=sgst; }
      else{ igst=basic*gst/100; }
    }
    let total=basic+sgst+cgst+igst;
    r.querySelector('.basic').innerText=basic.toFixed(2);
    r.querySelector('.sgst').innerText=sgst.toFixed(2);
    r.querySelector('.cgst').innerText=cgst.toFixed(2);
    r.querySelector('.igst').innerText=igst.toFixed(2);
    r.querySelector('.total').innerText=total.toFixed(2);
    gBasic+=basic; gSGST+=sgst; gCGST+=cgst; gIGST+=igst; gTotal+=total;
  });
  document.querySelector('.grandBasic').innerText=gBasic.toFixed(2);
  document.querySelector('.grandSGST').innerText=gSGST.toFixed(2);
  document.querySelector('.grandCGST').innerText=gCGST.toFixed(2);
  document.querySelector('.grandIGST').innerText=gIGST.toFixed(2);
  document.querySelector('.grandTotal').innerText=gTotal.toFixed(2);
  document.getElementById('totalInvoice').value=gTotal.toFixed(2);
  updateBalance();
}

// === Balance ===
function updateBalance(){
  const total=parseFloat(document.getElementById('totalInvoice').value)||0;
  const rec=parseFloat(document.getElementById('paymentReceived').value)||0;
  document.getElementById('balanceAmount').value=(total-rec).toFixed(2);
}

// === PDF ===
// === PDF ===
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = {left:14, right:14, top:15, bottom:18};
  const n = v => (parseFloat(v)||0).toFixed(2);

  // ===== Values =====
  const taxable = parseFloat(document.querySelector('.grandBasic').innerText)||0;
  const sgst = parseFloat(document.querySelector('.grandSGST').innerText)||0;
  const cgst = parseFloat(document.querySelector('.grandCGST').innerText)||0;
  const igst = parseFloat(document.querySelector('.grandIGST').innerText)||0;
  const totalGST = sgst+cgst+igst;
  const gTotal = parseFloat(document.querySelector('.grandTotal').innerText)||0;
  const paid = parseFloat(document.getElementById('paymentReceived').value)||0;
  const balance = gTotal-paid;

  const sellerState = document.getElementById("sellerState").value || "Seller State";
  const paymentType = document.getElementById("paymentType") ? document.getElementById("paymentType").value : "N/A";
  const buyerName = (document.getElementById("buyerName").value || "Buyer").replace(/\s+/g,'_');
  const invoiceNo = (document.getElementById("invoiceNo").value || "Invoice");
  const invoiceDate = document.getElementById("invoiceDate").value;
  let formattedDate = "-";
  if (invoiceDate) {
    const d = invoiceDate.split('-');
    if (d.length === 3) formattedDate = `${d[2]}/${d[1]}/${d[0]}`;
  }

  // ===== Number to Words =====
  function inWords(num){
    const a=['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten',
    'Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
    const b=['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
    if((num=num.toString()).length>9) return 'Overflow';
    const n=('000000000'+num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
    if(!n) return; let str='';
    str+=(n[1]!=0)?(a[Number(n[1])]||b[n[1][0]]+' '+a[n[1][1]])+' Crore ':'';
    str+=(n[2]!=0)?(a[Number(n[2])]||b[n[2][0]]+' '+a[n[2][1]])+' Lakh ':'';
    str+=(n[3]!=0)?(a[Number(n[3])]||b[n[3][0]]+' '+a[n[3][1]])+' Thousand ':'';
    str+=(n[4]!=0)?(a[Number(n[4])]||b[n[4][0]]+' '+a[n[4][1]])+' Hundred ':'';
    str+=(n[5]!=0)?((str!='')?'and ':'')+(a[Number(n[5])]||b[n[5][0]]+' '+a[n[5][1]])+' ':''; 
    return str.trim()+" Only";
  }
  const amountWords = inWords(Math.round(gTotal));

  // ===== Footer =====
  function addFooter() {
    doc.setFontSize(9);
    doc.setFont('helvetica','bold');
    doc.setTextColor(100);
    doc.text(
      "Software Developed By: S World The Complete Accounting Solutions, Balaghat. Mob: 8319601616",
      pageWidth/2,
      pageHeight - 6,
      {align:'center'}
    );
    doc.setTextColor(0);
  }

  // ===== Watermark =====
  async function getFaintLogo(dataURL, opacity=0.01) {
    return new Promise(resolve=>{
      if (!dataURL) return resolve(null);
      const img = new Image();
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.globalAlpha = opacity;
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL('image/png'));
      };
      img.onerror = ()=> resolve(null);
      img.src = dataURL;
    });
  }
  const faintLogo = await getFaintLogo(localStorage.getItem('logo'),0.1);

  function addWatermark(docRef) {
    if (!faintLogo) return;
    const wmWidth = pageWidth * 0.35;
    const wmHeight = pageHeight * 0.35;
    const x = (pageWidth - wmWidth) / 2;
    const y = (pageHeight - wmHeight) / 2;
    docRef.addImage(faintLogo,'PNG',x,y,wmWidth,wmHeight);
  }

  // ===== Header =====
  function drawHeader(){
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text("TAX INVOICE", pageWidth/2, margin.top, {align:"center"});

    let y = 38;
    doc.setFontSize(10); doc.setFont('helvetica','bold'); 
    doc.text("Seller:",margin.left,y);
    doc.text(document.getElementById("sellerName").value||"-",margin.left,y+5);
    doc.text("GSTIN: "+(document.getElementById("sellerGST").value||"-"),margin.left,y+10);
    const sAddr = document.getElementById("sellerAddress").value || "-";
    const sLines = doc.splitTextToSize("Address: " + sAddr, (pageWidth/2 - margin.left - 5));
    doc.text(sLines, margin.left, y+15);
    let sH = (sLines.length - 1) * doc.getLineHeight() / doc.internal.scaleFactor;
    doc.text("State: "+(sellerState||"-"),margin.left,y+15+sH+5);

    doc.text("Buyer:",pageWidth/2,y);
    const bAddr = document.getElementById("buyerAddress").value || "-";
    const bLines = doc.splitTextToSize("Address: " + bAddr, (pageWidth/2 - margin.right - 5));
    doc.text(document.getElementById("buyerName").value||"-",pageWidth/2,y+5);
    doc.text("GSTIN: "+(document.getElementById("buyerGST").value||"-"),pageWidth/2,y+10);
    doc.text(bLines, pageWidth/2, y+15);
    let bH = (bLines.length - 1) * doc.getLineHeight() / doc.internal.scaleFactor;
    doc.text("State: "+(document.getElementById("buyerState").value||"-"),pageWidth/2,y+15+bH+5);

    let invY = y + 28 + Math.max(sH,bH) + 5;
    doc.text("Invoice No: "+(invoiceNo||"-"),margin.left,invY);
    doc.text("Date: "+formattedDate,pageWidth/2,invY);

    return invY + 10;
  }

  // ===== First page =====
  addWatermark(doc);
  const headerBottomY = drawHeader();
  addFooter();

  // ===== Items Table =====
  const rows = document.querySelectorAll("#itemsTable tbody tr");

  let hasSGST = false, hasCGST = false, hasIGST = false;
  rows.forEach(r=>{
    if (parseFloat(r.querySelector(".sgst").innerText) > 0) hasSGST = true;
    if (parseFloat(r.querySelector(".cgst").innerText) > 0) hasCGST = true;
    if (parseFloat(r.querySelector(".igst").innerText) > 0) hasIGST = true;
  });

  let itemHead = ['Item','HSN','GST Rate','Qty','Price (Incl GST)','Basic'];
  if (hasSGST) itemHead.push('SGST');
  if (hasCGST) itemHead.push('CGST');
  if (hasIGST) itemHead.push('IGST');
  itemHead.push('Total');

  const body = [];
  rows.forEach(r=>{
    const row = [
      r.querySelector(".itemName").value||"-",
      r.querySelector(".hsnCode").value||"-",
      (r.querySelector(".gstRate").value||"0")+"%",
      r.querySelector(".quantity").value||"0",
      r.querySelector(".price").value||"0",
      r.querySelector(".basic").innerText||"0"
    ];
    if (hasSGST) row.push(r.querySelector(".sgst").innerText||"0");
    if (hasCGST) row.push(r.querySelector(".cgst").innerText||"0");
    if (hasIGST) row.push(r.querySelector(".igst").innerText||"0");
    row.push(r.querySelector(".total").innerText||"0");
    body.push(row);
  });

  const firstBatch = body.slice(0,15);
  const remainingBatch = body.slice(15);

  doc.autoTable({
    startY: headerBottomY,
    margin:{left:margin.left, right:margin.right},
    head:[itemHead],
    body:firstBatch,
    theme:'plain',
    styles:{fontSize:9, lineWidth:0.2, lineColor:[120,120,120], fillColor:false},
    headStyles:{
      fillColor:[220,235,245], // darker Alice Blue
      textColor:[0,0,0],
      fontStyle:'bold',
      halign:'center'
    },
    bodyStyles:{fillColor:false},
    alternateRowStyles:{fillColor:false},
    columnStyles:{0:{halign:'left'},1:{halign:'left'}}
  });

  let cursorY = doc.lastAutoTable.finalY + 10;

  if (remainingBatch.length > 0){
    doc.addPage();
    addWatermark(doc);
    const newHeaderY = drawHeader();
    addFooter();

    doc.autoTable({
      startY:newHeaderY,
      margin:{left:margin.left, right:margin.right},
      head:[itemHead],
      body:remainingBatch,
      theme:'plain',
      styles:{fontSize:9, lineWidth:0.2, lineColor:[120,120,120], fillColor:false},
      headStyles:{
        fillColor:[220,235,245], // darker Alice Blue
        textColor:[0,0,0],
        fontStyle:'bold',
        halign:'center'
      },
      bodyStyles:{fillColor:false},
      alternateRowStyles:{fillColor:false},
      columnStyles:{0:{halign:'left'},1:{halign:'left'}}
    });

    cursorY = doc.lastAutoTable.finalY + 10;
  }

  // ===== Notes (left) + Payment Summary (right) =====
  let notesStartY = cursorY;

  // Notes
  doc.setFontSize(9); doc.setFont('helvetica','bold');
  doc.text("Notes:", margin.left, notesStartY);

  const noteLines = [
    "- This is a computer-generated invoice. No signature required.",
    `- Subject to ${sellerState} jurisdiction only.`,
    "- Thank you for your business!"
  ];
  let wrapWidth = pageWidth/2 - margin.left - 4;
  let noteY = notesStartY + 6;
  noteLines.forEach(line=>{
    const wrapped = doc.splitTextToSize(line, wrapWidth);
    doc.text(wrapped, margin.left, noteY);
    noteY += wrapped.length * 5 + 2;
  });

  doc.setFontSize(10);
  doc.setTextColor(0,0,128); // navy blue
  doc.text("Grand Total (in words):", margin.left, noteY + 4);
  const wrappedWords = doc.splitTextToSize(amountWords, wrapWidth);
  doc.text(wrappedWords, margin.left, noteY + 10);
  doc.setTextColor(0,0,0); // reset
  let notesEndY = noteY + wrappedWords.length * 5 + 15;

  // Payment Summary
  doc.autoTable({
    startY: notesStartY,
    margin:{left:pageWidth/2,right:margin.right},
    head:[["Particulars","Amount"]],
    body:[
      ["Total Taxable Value",n(taxable)],
      ["Total GST",n(totalGST)],
      [{content:"Grand Total", styles:{fontStyle:'bold'}},{content:n(gTotal), styles:{fontStyle:'bold'}}],
      ["Paid Amount",n(paid)],
      ["Payment Type",paymentType],
      [{content:"Balance Amount", styles:{textColor:[0,0,128], fontStyle:'bold'}},
       {content:n(balance), styles:{textColor:[0,0,128], fontStyle:'bold'}}]
    ],
    theme:'plain',
    styles:{fontSize:9, lineWidth:0.2, lineColor:[150,150,150], fillColor:false},
    headStyles:{fillColor:[220,235,245], textColor:[0,0,0], fontStyle:'bold'},
    bodyStyles:{fillColor:false},
    alternateRowStyles:{fillColor:false},
    columnStyles:{0:{halign:'left'},1:{halign:'right'}}
  });

  let paymentEndY = doc.lastAutoTable.finalY;
  cursorY = Math.max(notesEndY, paymentEndY) + 10;

  // ===== HSN Summary =====
  const hsnSummary = {};
  rows.forEach(r=>{
    const hsn = r.querySelector(".hsnCode").value || "N/A";
    const gstRate = r.querySelector(".gstRate").value || "0";
    const taxableValue = parseFloat(r.querySelector(".basic").innerText) || 0;
    const sgstVal = parseFloat(r.querySelector(".sgst").innerText) || 0;
    const cgstVal = parseFloat(r.querySelector(".cgst").innerText) || 0;
    const igstVal = parseFloat(r.querySelector(".igst").innerText) || 0;
    const key = `${hsn}-${gstRate}`;
    if (!hsnSummary[key]) hsnSummary[key] = {hsn,gstRate,taxable:0,sgst:0,cgst:0,igst:0};
    hsnSummary[key].taxable += taxableValue;
    hsnSummary[key].sgst += sgstVal;
    hsnSummary[key].cgst += cgstVal;
    hsnSummary[key].igst += igstVal;
  });

  const hsnTotals = {taxable:0,sgst:0,cgst:0,igst:0};
  Object.values(hsnSummary).forEach(item=>{
    hsnTotals.taxable += item.taxable;
    hsnTotals.sgst += item.sgst;
    hsnTotals.cgst += item.cgst;
    hsnTotals.igst += item.igst;
  });

  const hsnHead = ["HSN","GST Rate","Taxable"];
  if (hasSGST) hsnHead.push("SGST");
  if (hasCGST) hsnHead.push("CGST");
  if (hasIGST) hsnHead.push("IGST");

  const hsnTableData = Object.values(hsnSummary).map(item => {
    const row = [item.hsn, item.gstRate+'%', n(item.taxable)];
    if (hasSGST) row.push(n(item.sgst));
    if (hasCGST) row.push(n(item.cgst));
    if (hasIGST) row.push(n(item.igst));
    return row;
  });

  if (hsnTableData.length>0){
    const totalRow = [
      {content:"Grand Total", styles:{fontStyle:'bold'}},
      {content:"-", styles:{fontStyle:'bold'}},
      {content:n(hsnTotals.taxable), styles:{fontStyle:'bold'}}
    ];
    if (hasSGST) totalRow.push({content:n(hsnTotals.sgst), styles:{fontStyle:'bold'}});
    if (hasCGST) totalRow.push({content:n(hsnTotals.cgst), styles:{fontStyle:'bold'}});
    if (hasIGST) totalRow.push({content:n(hsnTotals.igst), styles:{fontStyle:'bold'}});
    hsnTableData.push(totalRow);

    doc.autoTable({
      startY: cursorY,
      head:[hsnHead],
      body:hsnTableData,
      theme:'plain',
      styles:{fontSize:9, lineWidth:0.2, lineColor:[150,150,150], fillColor:false},
      headStyles:{
        fillColor:[220,235,245], // darker Alice Blue
        textColor:[0,0,0],
        fontStyle:'bold'
      },
      bodyStyles:{fillColor:false},
      alternateRowStyles:{fillColor:false},
      margin:{left:margin.left},
      pageBreak:'auto'
    });

    cursorY = doc.lastAutoTable.finalY + 10;
  }

  // ===== Signature =====
  let sigY = cursorY + 10;
  if (sigY > pageHeight - 30) {  
    doc.addPage();
    addWatermark(doc);
    sigY = drawHeader() + 20;
    addFooter();
  }

  const sigData = localStorage.getItem('signature');
  if (sigData){ doc.addImage(sigData,'JPEG', pageWidth - margin.right - 40, sigY, 40,20); sigY+=22; }
  doc.text("For "+(document.getElementById("sellerName").value||"Seller"),pageWidth-margin.right,sigY,{align:'right'});
  doc.text("(Authorized Signatory)",pageWidth-margin.right,sigY+6,{align:'right'});

  addFooter();
  doc.save(`${buyerName}_${invoiceNo}.pdf`);
}

  const sigData = localStorage.getItem('signature');
  if (sigData){ doc.addImage(sigData,'JPEG', pageWidth - margin.right - 40, sigY, 40,20); sigY+=22; }
  doc.text("For "+(document.getElementById("sellerName").value||"Seller"),pageWidth-margin.right,sigY,{align:'right'});
  doc.text("(Authorized Signatory)",pageWidth-margin.right,sigY+6,{align:'right'});

  addFooter();
  doc.save(`${buyerName}_${invoiceNo}.pdf`);
}


attachEvents();
calculateInvoice();
</script>
</body>
</html>




